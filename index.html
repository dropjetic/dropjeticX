<script>
  const API_BASE = "http://localhost:8000";
  let token = localStorage.getItem("fax_token");
  let currentChatId = null;
  const messagesDiv = document.getElementById("messages");
  const promptInput = document.getElementById("prompt");
  const sendBtn = document.getElementById("send");
  const newChatBtn = document.getElementById("new-chat");
  const chatList = document.getElementById("chat-list");
  const searchInput = document.getElementById("search-input");
  const authBtn = document.getElementById("auth-btn");
  const body = document.body;

  const suggestions = [
    "Explain quantum computing in simple terms",
    "Write a Python script to fetch weather data",
    "Help me plan a 3-day trip to Kyoto",
    "Brainstorm names for a sci-fi novel",
    "Teach me how to prompt AI better",
    "Compare the latest smartphone rumors"
  ];

  function showWelcome() {
    if (messagesDiv.querySelector('.welcome')) return;
    messagesDiv.innerHTML = `
      <div class="welcome">
        <h1>Fax AI</h1>
        <div class="suggestions">
          ${suggestions.map(s => `
            <div class="suggestion-chip" onclick="document.getElementById('prompt').value = '${s.replace(/'/g, "\\'")}'; document.getElementById('prompt').focus();">
              ${s}
            </div>
          `).join('')}
        </div>
      </div>
    `;
    body.classList.add("has-no-messages");
  }

  async function loadChats() {
    if (!token) return;
    try {
      const res = await fetch(`${API_BASE}/chats`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) throw new Error();
      const chats = await res.json();
      chatList.innerHTML = "";
      chats.forEach(c => {
        const item = document.createElement("div");
        item.className = `chat-item${c.id === currentChatId ? " active" : ""}`;
        item.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span>${c.title}</span>`;
        item.onclick = () => loadChat(c.id);
        chatList.appendChild(item);
      });
      // If there are chats, auto-load the most recent one after login/refresh
      if (chats.length > 0 && !currentChatId) {
        loadChat(chats[0].id);
      }
    } catch {
      logout();
    }
  }

  async function loadChat(id) {
    if (!token) {
      currentChatId = id;
      messagesDiv.innerHTML = "";
      showWelcome();
      return;
    }
    currentChatId = id;
    try {
      const res = await fetch(`${API_BASE}/chats/${id}/messages`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) throw new Error();
      const msgs = await res.json();
      messagesDiv.innerHTML = "";
      if (msgs.length === 0) {
        showWelcome();
      } else {
        msgs.forEach(m => addMessage(m.role, m.content, false));
        body.classList.remove("has-no-messages");
      }
      document.querySelectorAll(".chat-item").forEach(el => el.classList.remove("active"));
      const active = Array.from(chatList.children).find(el => el.onclick?.toString().includes(id));
      if (active) active.classList.add("active");
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch {}
  }

  function addMessage(role, content, scroll = true) {
    const div = document.createElement("div");
    div.className = `message ${role}`;
    let html = content
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/```([\s\S]*?)```/g, '<pre>$1</pre>')
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/\n/g, '<br>');
    div.innerHTML = html;
    messagesDiv.appendChild(div);
    if (scroll) messagesDiv.scrollTop = messagesDiv.scrollHeight;
    body.classList.remove("has-no-messages");
  }

  async function typeResponse(element, text) {
    element.textContent = '';
    for (let char of text) {
      element.textContent += char;
      await new Promise(r => setTimeout(r, Math.random() * 6 + 3));
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  }

  async function sendMessage() {
    const text = promptInput.value.trim();
    if (!text) return;

    addMessage("user", text);
    promptInput.value = "";
    promptInput.style.height = "auto";

    const statusDiv = document.createElement("div");
    statusDiv.className = "status";
    statusDiv.textContent = "Thinking";
    messagesDiv.appendChild(statusDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    try {
      if (token && currentChatId && typeof currentChatId === 'number') {
        await fetch(`${API_BASE}/chats/${currentChatId}/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ role: "user", content: text })
        });
      }

      const headers = { "Content-Type": "application/json" };
      if (token) headers["Authorization"] = `Bearer ${token}`;

      let res = await fetch(`${API_BASE}/generate`, {
        method: "POST",
        headers,
        body: JSON.stringify({ prompt: text })
      });

      if (res.status === 401 && token) {
        res = await fetch(`${API_BASE}/generate?public=true`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: text })
        });
      }

      if (!res.ok) throw new Error(`Generation failed (${res.status})`);

      const json = await res.json();
      const reply = json.response || "(no response)";
      statusDiv.remove();

      const assistantDiv = document.createElement("div");
      assistantDiv.className = "message assistant";
      messagesDiv.appendChild(assistantDiv);
      await typeResponse(assistantDiv, reply);

      if (token && currentChatId && typeof currentChatId === 'number') {
        await fetch(`${API_BASE}/chats/${currentChatId}/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ role: "assistant", content: reply })
        });
      }

      if (token) loadChats(); // refresh list if needed
    } catch (err) {
      statusDiv.remove();
      addMessage("assistant", `Error: ${err.message}`);
    }
  }

  async function createNewChat() {
    if (!token) {
      currentChatId = "temp-" + Date.now();
      messagesDiv.innerHTML = "";
      showWelcome();
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/chats`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({})
      });
      if (!res.ok) throw new Error();
      const data = await res.json();
      currentChatId = data.id;
      loadChats();
      loadChat(data.id);
    } catch {}
  }

  function logout() {
    localStorage.removeItem("fax_token");
    token = null;
    authBtn.textContent = "Login";
    authBtn.onclick = () => window.location.href = "login.html";
    chatList.innerHTML = "";
    currentChatId = null;
    messagesDiv.innerHTML = "";
    showWelcome();
  }

  sendBtn.onclick = sendMessage;
  promptInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  promptInput.addEventListener("input", () => {
    promptInput.style.height = "auto";
    promptInput.style.height = Math.min(promptInput.scrollHeight, 160) + "px";
  });

  newChatBtn.onclick = createNewChat;

  authBtn.onclick = () => window.location.href = "login.html";

  // ───────────────────────────────────────────────
  // Main initialization
  // ───────────────────────────────────────────────
  if (token) {
    authBtn.textContent = "Logout";
    authBtn.onclick = logout;
    loadChats();           // load existing chats
    // Do NOT auto-create new chat here → only load existing or let user click "New chat"
  } else {
    showWelcome();
  }
</script>
